// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏≤‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

// Helper: ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö rule-based ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
function answerCheapestDormQuery(message, dorms) {
  const msg = message.toLowerCase();
  
  // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏≤‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
  if (/‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å|‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î|‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡∏î|‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥|‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢/.test(msg) && /‡∏´‡∏≠/.test(msg)) {
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å‡∏ñ‡∏π‡∏Å‡πÑ‡∏õ‡πÅ‡∏û‡∏á (‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å)
    const sortedDorms = [...dorms].sort((a, b) => {
      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)
      const getComparablePrice = (dorm) => {
        const monthly = dorm.price_monthly && Number(dorm.price_monthly) > 0 ? Number(dorm.price_monthly) : null;
        const daily = dorm.price_daily && Number(dorm.price_daily) > 0 ? Number(dorm.price_daily) * 30 : null; // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        
        // ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô*30
        return monthly || daily || Infinity;
      };
      
      const priceA = getComparablePrice(a);
      const priceB = getComparablePrice(b);
      
      return priceA - priceB;
    });

    const cheapestDorms = sortedDorms.slice(0, 3).filter(d => {
      // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
      const hasMonthly = d.price_monthly && Number(d.price_monthly) > 0;
      const hasDaily = d.price_daily && Number(d.price_daily) > 0;
      return hasMonthly || hasDaily;
    });

    if (cheapestDorms.length > 0) {
      let response = `üè† **‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å:**\n\n`;
      
      cheapestDorms.forEach((dorm, index) => {
        // Format ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà ChatbotWidget ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ parse ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏î‡πâ
        response += `${index + 1}. üè† **${dorm.name}**\n`;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const askingDailyRate = /‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô|‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô|‡∏ß‡∏±‡∏ô‡∏•‡∏∞|daily/.test(message.toLowerCase());
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        if (askingDailyRate) {
          // ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
          if (dorm.price_daily && Number(dorm.price_daily) > 0) {
            response += `   üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: ‡∏ø${Number(dorm.price_daily).toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
          }
          if (dorm.price_monthly && Number(dorm.price_monthly) > 0) {
            response += `   üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡∏ø${Number(dorm.price_monthly).toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
          }
        } else {
          // ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
          if (dorm.price_monthly && Number(dorm.price_monthly) > 0) {
            response += `   üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡∏ø${Number(dorm.price_monthly).toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
          }
          if (dorm.price_term && Number(dorm.price_term) > 0) {
            response += `   üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏°: ‡∏ø${Number(dorm.price_term).toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
          }
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å
        if (dorm.facilities) {
          response += `   üåü ‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å: ${dorm.facilities}\n`;
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á/‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ö
        if (dorm.near_places) {
          response += `   üìç ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á: ‡πÉ‡∏Å‡∏•‡πâ${dorm.near_places}\n`;
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
        if (dorm.contact_phone) {
          response += `   üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${dorm.contact_phone}\n`;
        }
        
        response += `\n`;
      });
      
      response += `üí° **‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:** ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏π‡∏Å‡πÑ‡∏õ‡πÅ‡∏û‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô\n`;
      response += `‚ú® ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°`;
      return response;
    }
  }
  
  return null; // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
}

module.exports = { answerCheapestDormQuery };
